pipeline {
    agent any

    environment {
        SERVICE_NAME    = "gallery_service"
        DOCKER_IMAGE    = "memory-${SERVICE_NAME}"
        DOCKER_REGISTRY = "tuan4886"
        TAG             = "${env.BUILD_NUMBER ?: 'dev'}"
        DOCKER_REPO     = "${DOCKER_REGISTRY}/${DOCKER_IMAGE}" 
    }

    stages {
        stage('Prepare Env File') {
            steps {
                withCredentials([
                    usernamePassword(credentialsId: 'gallery-db-credential-test',
                                     usernameVariable: 'DB_USER',
                                     passwordVariable: 'DB_PASS'),
                    string(credentialsId: 'jwt-secret', variable: 'JWT_SECRET')
                ]) {
                    sh '''
                        # Tạo file env cho Test
                        ENV_FILE="gallery_service/tests/.env.db.gallery.test"
                        echo "POSTGRES_HOST=gallery-db-test" > $ENV_FILE
                        echo "POSTGRES_PORT=5432" >> $ENV_FILE
                        echo "POSTGRES_DB=gallery_test_db" >> $ENV_FILE
                        echo "POSTGRES_USER=$DB_USER" >> $ENV_FILE
                        echo "POSTGRES_PASSWORD=$DB_PASS" >> $ENV_FILE

                        echo "DB_USER=$DB_USER" >> $ENV_FILE
                        echo "DB_PASSWORD=$DB_PASS" >> $ENV_FILE
                        echo "DB_NAME=gallery_test_db" >> $ENV_FILE
                        echo "DB_HOST=gallery-db-test" >> $ENV_FILE
                        echo "DB_PORT=5432" >> $ENV_FILE

                        # DÒNG QUAN TRỌNG NHẤT CHO ALEMBIC:
                        echo "DATABASE_URL=postgresql://$DB_USER:$DB_PASS@gallery-db-test:5432/gallery_test_db" >> $ENV_FILE

                        echo "SECRET_KEY=$JWT_SECRET" >> $ENV_FILE
                        echo "ALGORITHM=HS256" >> $ENV_FILE
                        echo "ACCESS_TOKEN_EXPIRE_MINUTES=30" >> $ENV_FILE
                        
                        # Copy sang file .env.gallery để app và alembic dùng chung trong container test
                        cp $ENV_FILE gallery_service/.env.gallery
                    '''
                }
            }
        }

        stage('Test') {
            steps {
                echo 'Starting build and test for gallery_service...'
                dir("${SERVICE_NAME}") {
                    // Dọn container trước khi test
                    sh 'docker-compose -f docker-compose.gallery.test.yml down -v'

                    // Build và chạy test, log kết quả rõ ràng
                    sh 'docker-compose -f docker-compose.gallery.test.yml up --build --exit-code-from gallery-service-test'
                    
                    // Dọn sau test
                    sh 'docker-compose -f docker-compose.gallery.test.yml down -v'
                }
            }
        }

        stage('Build & Push Production Image') {
            steps {
                script {
                    echo "Building Production Image..."
                    // Build image - Đảm bảo lệnh COPY trong Dockerfile bốc được thư mục alembic/ và app/
                    sh "docker build --pull -t ${DOCKER_REPO}:${TAG} -t ${DOCKER_REPO}:latest -f ${SERVICE_NAME}/Dockerfile ."
                    
                    withDockerRegistry(credentialsId: 'dockerhub-credentials', url: '') {
                        sh "docker push ${DOCKER_REPO}:${TAG}"
                        sh "docker push ${DOCKER_REPO}:latest"
                    }
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    echo "Deploying ${DOCKER_REPO}:latest to Docker Desktop Kubernetes..."
                    withCredentials([file(credentialsId: 'docker-desktop-kubeconfig', variable: 'KUBECONFIG_FILE')]) {

                        sh "kubectl --kubeconfig=$KUBECONFIG_FILE apply -f ${SERVICE_NAME}/k8s/namespace.yml"
                        
                        // Apply secret manifest
                        withCredentials([file(credentialsId: 'k8s-secret-file-gallery_service', variable: 'SECRET_FILE')]) {
                            sh "kubectl --kubeconfig=$KUBECONFIG_FILE apply -f $SECRET_FILE"
                        }

                        // Sử dụng mảng để apply cho gọn và sạch (Đã bổ sung media-pvc.yml)
                        def k8sFiles = [
                            'postgres-pvc.yml', 'postgres-deployment.yml', 'postgres-service.yml',
                            'media-pvc.yml', 'deployment.yml', 'service.yml'
                        ]
                        for (file in k8sFiles) {
                            sh "kubectl --kubeconfig=$KUBECONFIG_FILE -n gallery apply -f ${SERVICE_NAME}/k8s/${file}"
                        }

                        // Force restart deployment để nhận image mới nhất
                        sh "kubectl --kubeconfig=$KUBECONFIG_FILE -n gallery rollout restart deployment/gallery-service"
                        
                        // Kiểm tra rollout
                        sh "kubectl --kubeconfig=$KUBECONFIG_FILE -n gallery rollout status deployment/gallery-service --timeout=180s"
                    }

                    echo "Deploy lên Docker Desktop Kubernetes thành công!"
                }
            }
        }
    }
    post {
        always {
            echo "Cleaning workspace..."
            cleanWs()
        }
    }
}